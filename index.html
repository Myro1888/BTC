<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="theme-color" content="#0f172a">
<title>Bitcoin Fear & Greed Trading Dashboard</title>
<style>
*{margin:0;padding:0;box-sizing:border-box}
body{background:#0f172a;color:#e2e8f0;font-family:-apple-system,BlinkMacSystemFont,'SF Mono','Fira Code',monospace;line-height:1.5}
.container{max-width:1200px;margin:0 auto;padding:12px}
.header{text-align:center;padding:16px 0}
.header h1{font-size:clamp(16px,3.5vw,24px);color:#fff;margin-bottom:4px}
.header .sub{font-size:11px;color:#64748b;margin-bottom:6px}
.header .meta{font-size:10px;color:#475569;display:flex;justify-content:center;gap:12px;flex-wrap:wrap}

/* Main Cycle Gauge */
.cycle-panel{background:linear-gradient(135deg,rgba(30,41,59,0.9),rgba(15,23,42,0.95));border:2px solid #334155;border-radius:16px;padding:24px;margin-bottom:16px;text-align:center}
.cycle-title{font-size:12px;color:#94a3b8;text-transform:uppercase;letter-spacing:2px;margin-bottom:16px}
.cycle-gauge{position:relative;margin:0 auto 16px;max-width:400px}
.cycle-bar{height:32px;background:linear-gradient(90deg,#22c55e 0%,#22c55e 20%,#86efac 20%,#86efac 35%,#fde047 35%,#fde047 50%,#fde047 50%,#fde047 65%,#fb923c 65%,#fb923c 80%,#ef4444 80%,#ef4444 100%);border-radius:16px;position:relative}
.cycle-zones{display:flex;justify-content:space-between;font-size:8px;color:#64748b;margin-top:4px;padding:0 4px}
.cycle-needle{position:absolute;top:-8px;width:6px;height:48px;background:#fff;border-radius:3px;transform:translateX(-50%);box-shadow:0 0 10px rgba(255,255,255,0.5)}
.cycle-value{font-size:48px;font-weight:bold;margin:16px 0 8px}
.cycle-label{font-size:18px;font-weight:bold;margin-bottom:8px}
.cycle-action{font-size:14px;padding:12px 24px;border-radius:8px;display:inline-block;margin-top:8px}

/* Action Panel */
.action-panel{display:grid;grid-template-columns:1fr 1fr 1fr;gap:16px;margin-bottom:16px}
.action-box{background:#1e293b;border:2px solid #334155;border-radius:12px;padding:20px;text-align:center}
.action-box.active{border-color:#22c55e;box-shadow:0 0 20px rgba(34,197,94,0.3)}
.action-box.active-sell{border-color:#ef4444;box-shadow:0 0 20px rgba(239,68,68,0.3)}
.action-box .label{font-size:10px;color:#94a3b8;text-transform:uppercase;letter-spacing:1px;margin-bottom:8px}
.action-box .value{font-size:28px;font-weight:bold}
.action-box .sub{font-size:10px;color:#64748b;margin-top:4px}

/* Confidence Meter */
.confidence-section{background:#1e293b;border:1px solid #334155;border-radius:12px;padding:16px;margin-bottom:16px}
.confidence-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.confidence-title{font-size:11px;color:#94a3b8;text-transform:uppercase;letter-spacing:1px}
.confidence-value{font-size:14px;font-weight:bold}
.confidence-bar{height:12px;background:#0f172a;border-radius:6px;overflow:hidden;display:flex}
.confidence-segment{height:100%;transition:width 0.5s}
.indicator-dots{display:flex;justify-content:space-around;margin-top:12px}
.indicator-dot{display:flex;flex-direction:column;align-items:center;gap:4px}
.indicator-dot .dot{width:16px;height:16px;border-radius:50%;border:2px solid #334155}
.indicator-dot .dot.active-buy{background:#22c55e;border-color:#22c55e;box-shadow:0 0 8px rgba(34,197,94,0.5)}
.indicator-dot .dot.active-sell{background:#ef4444;border-color:#ef4444;box-shadow:0 0 8px rgba(239,68,68,0.5)}
.indicator-dot .dot.neutral{background:#64748b;border-color:#64748b}
.indicator-dot .name{font-size:8px;color:#64748b;text-align:center;max-width:60px}

/* Indicator Cards - Simplified */
.indicators-grid{display:grid;grid-template-columns:repeat(4,1fr);gap:12px;margin-bottom:16px}
.ind-card{background:#1e293b;border:1px solid #334155;border-radius:10px;padding:14px}
.ind-card .ind-name{font-size:9px;color:#94a3b8;text-transform:uppercase;letter-spacing:0.5px;margin-bottom:6px;display:flex;justify-content:space-between;align-items:center}
.ind-card .ind-weight{font-size:8px;color:#475569;background:#0f172a;padding:2px 6px;border-radius:4px}
.ind-card .ind-value{font-size:22px;font-weight:bold;margin-bottom:4px}
.ind-card .ind-status{font-size:10px;margin-bottom:8px}
.ind-card .ind-meter{height:6px;background:#0f172a;border-radius:3px;overflow:hidden}
.ind-card .ind-fill{height:100%;border-radius:3px;transition:width 0.5s}
.ind-card .ind-thresholds{display:flex;justify-content:space-between;font-size:8px;color:#475569;margin-top:4px}

/* Price Action - Compact */
.price-action{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:16px}
.pa-card{background:#1e293b;border:1px solid #334155;border-radius:10px;padding:14px}
.pa-card .pa-period{font-size:9px;color:#94a3b8;text-transform:uppercase;letter-spacing:1px;margin-bottom:10px;font-weight:bold}
.pa-card .pa-main{display:flex;justify-content:space-between;align-items:center;margin-bottom:8px}
.pa-card .pa-signal{font-size:24px}
.pa-card .pa-label{font-size:12px;font-weight:bold}
.pa-card .pa-details{font-size:10px;color:#64748b}
.pa-card .pa-row{display:flex;justify-content:space-between;padding:4px 0;border-top:1px solid #334155}
.pa-card .pa-row:first-of-type{border-top:none}

/* Historical Context */
.history-panel{background:#1e293b;border:1px solid #334155;border-radius:12px;padding:16px;margin-bottom:16px}
.history-title{font-size:11px;color:#94a3b8;text-transform:uppercase;letter-spacing:1px;margin-bottom:12px}
.history-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
.history-item{background:#0f172a;border-radius:8px;padding:12px}
.history-item .h-label{font-size:9px;color:#64748b;margin-bottom:4px}
.history-item .h-value{font-size:14px;font-weight:bold}
.history-item .h-note{font-size:9px;color:#475569;margin-top:4px}

/* Strategy */
.strategy-panel{background:#1e293b;border:1px solid #334155;border-radius:12px;padding:16px;margin-bottom:16px}
.strategy-title{font-size:11px;color:#94a3b8;text-transform:uppercase;letter-spacing:1px;margin-bottom:12px}
.strategy-action{background:#0f172a;border-radius:8px;padding:16px;text-align:center;margin-bottom:12px}
.strategy-action .sa-label{font-size:10px;color:#64748b;margin-bottom:4px}
.strategy-action .sa-value{font-size:24px;font-weight:bold}
.strategy-action .sa-note{font-size:10px;color:#475569;margin-top:4px}
.ladder-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px}
.ladder-item{background:#0f172a;border-radius:6px;padding:10px;text-align:center}
.ladder-item .l-label{font-size:9px;color:#64748b;margin-bottom:4px}
.ladder-item .l-price{font-size:12px;font-weight:bold;color:#cbd5e1}
.ladder-item .l-alloc{font-size:11px;font-weight:bold;margin-top:4px}

/* Chart */
.chart-card{background:#1e293b;border:1px solid #334155;border-radius:12px;padding:16px;margin-bottom:16px}
.chart-title{font-size:11px;color:#94a3b8;text-transform:uppercase;letter-spacing:1px;margin-bottom:12px}
.chart-legend{display:flex;justify-content:center;gap:20px;margin-top:8px;font-size:10px;color:#64748b}
.chart-legend .dot{display:inline-block;width:14px;height:2px;margin-right:4px;vertical-align:middle}

/* Footer */
.footer{background:#1e293b;border:1px solid #334155;border-radius:12px;padding:16px}
.footer-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;font-size:9px;color:#64748b;margin-bottom:12px}
.warn-box{padding:10px;border-radius:6px;margin-bottom:8px;font-size:10px;line-height:1.5}
.warn-yellow{background:rgba(161,98,7,0.1);border:1px solid rgba(161,98,7,0.3);color:rgba(234,179,8,0.8)}
.warn-red{background:rgba(153,27,27,0.1);border:1px solid rgba(153,27,27,0.3);color:rgba(248,113,113,0.8)}

.loading{display:flex;align-items:center;justify-content:center;min-height:100vh;color:#94a3b8;font-size:14px}

@media(max-width:900px){
  .action-panel{grid-template-columns:1fr}
  .indicators-grid{grid-template-columns:repeat(2,1fr)}
  .price-action{grid-template-columns:1fr}
  .history-grid{grid-template-columns:1fr}
  .ladder-grid{grid-template-columns:1fr}
  .footer-grid{grid-template-columns:1fr}
}
</style>
</head>
<body>
<div id="app" class="loading">Loading Bitcoin Dashboard...</div>
<script>
(function(){
// ═══════ CACHE ═══════
var C={s:{},
set:function(k,v){this.s[k]={value:v,ts:Date.now()};try{localStorage.setItem('b_'+k,JSON.stringify(this.s[k]))}catch(e){}},
get:function(k,m){m=m||3600000;if(this.s[k]&&(Date.now()-this.s[k].ts)<m)return this.s[k];try{var x=localStorage.getItem('b_'+k);if(x){var p=JSON.parse(x);this.s[k]=p;if((Date.now()-p.ts)<m)return p;return{value:p.value,ts:p.ts,stale:true}}}catch(e){}return null},
any:function(k){if(this.s[k])return this.s[k];try{var x=localStorage.getItem('b_'+k);if(x){var p=JSON.parse(x);this.s[k]=p;return{value:p.value,ts:p.ts,stale:true}}}catch(e){}return null}
};

function esc(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;')}

function fj(url,t){t=t||10000;return new Promise(function(ok,fail){var d=false,tm=setTimeout(function(){d=true;fail(new Error('timeout'))},t);fetch(url).then(function(r){clearTimeout(tm);if(d)return;if(!r.ok)throw new Error(r.status);return r.json()}).then(function(x){if(!d)ok(x)}).catch(function(e){clearTimeout(tm);if(!d)fail(e)})})}

// ═══════ FETCH FUNCTIONS ═══════
function fetchPrice(){
  return fj('https://api.binance.com/api/v3/ticker/price?symbol=BTCUSDT').then(function(d){var p=parseFloat(d.price);if(p>0){C.set('price',p);return{price:p,src:'Binance'}}throw new Error('invalid price')}).catch(function(){
    return fj('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd').then(function(d){var p=parseFloat(d.bitcoin.usd);if(!(p>0))throw new Error('invalid price');C.set('price',p);return{price:p,src:'CoinGecko'}}).catch(function(){
      return fj('https://blockchain.info/ticker').then(function(d){var p=parseFloat(d.USD.last);if(!(p>0))throw new Error('invalid price');C.set('price',p);return{price:p,src:'Blockchain.info'}}).catch(function(){
        var c=C.any('price');return c?{price:c.value,src:'Cached',stale:true,ct:c.ts}:{price:0,src:'Unavailable',err:true}})})})
}

function parseMAcg(d){
  var p=d.prices;if(!p||p.length<50)throw new Error('insufficient data');
  // Calculate various MAs from weekly data
  var l200=p.slice(-200),s200=0;for(var i=0;i<l200.length;i++)s200+=l200[i][1];var ma200w=s200/l200.length;
  // 2-Year MA (104 weeks)
  var l104=p.slice(-104),s104=0;for(var i=0;i<l104.length;i++)s104+=l104[i][1];var ma2y=s104/l104.length;
  // Recent MAs for trend (approximate from weekly)
  var l13=p.slice(-13),s13=0;for(var i=0;i<l13.length;i++)s13+=l13[i][1];var ma90d=s13/l13.length; // ~90 days
  var l4=p.slice(-4),s4=0;for(var i=0;i<l4.length;i++)s4+=l4[i][1];var ma30d=s4/l4.length; // ~30 days
  var l1=p.slice(-1);var ma7d=l1.length>0?l1[0][1]:0; // Most recent week as proxy
  // Weekly prices for chart
  var wp=p.slice(-52).map(function(x){return{d:new Date(x[0]).toLocaleDateString('en-US',{month:'short',day:'numeric'}),p:Math.round(x[1]),m:Math.round(ma200w)}});
  var result={ma:ma200w,ma2y:ma2y,ma90d:ma90d,ma30d:ma30d,ma7d:ma7d,wp:wp};
  C.set('ma',result);return{ma:ma200w,ma2y:ma2y,ma90d:ma90d,ma30d:ma30d,ma7d:ma7d,wp:wp,src:'CoinGecko'};
}

function parseMAbin(data){
  if(!data||data.length<50)throw new Error('insufficient data');
  var l200=data.slice(-200),s200=0;for(var i=0;i<l200.length;i++)s200+=parseFloat(l200[i][4]);var ma200w=s200/l200.length;
  var l104=data.slice(-104),s104=0;for(var i=0;i<l104.length;i++)s104+=parseFloat(l104[i][4]);var ma2y=s104/l104.length;
  var l13=data.slice(-13),s13=0;for(var i=0;i<l13.length;i++)s13+=parseFloat(l13[i][4]);var ma90d=s13/l13.length;
  var l4=data.slice(-4),s4=0;for(var i=0;i<l4.length;i++)s4+=parseFloat(l4[i][4]);var ma30d=s4/l4.length;
  var l1=data.slice(-1);var ma7d=l1.length>0?parseFloat(l1[0][4]):0;
  var wp=data.slice(-52).map(function(x){return{d:new Date(x[0]).toLocaleDateString('en-US',{month:'short',day:'numeric'}),p:Math.round(parseFloat(x[4])),m:Math.round(ma200w)}});
  var result={ma:ma200w,ma2y:ma2y,ma90d:ma90d,ma30d:ma30d,ma7d:ma7d,wp:wp};
  C.set('ma',result);return{ma:ma200w,ma2y:ma2y,ma90d:ma90d,ma30d:ma30d,ma7d:ma7d,wp:wp,src:'Binance'};
}

function fetchMA(){
  var c=C.get('ma',86400000);if(c&&!c.stale)return Promise.resolve({ma:c.value.ma,ma2y:c.value.ma2y||c.value.ma,ma90d:c.value.ma90d||c.value.ma,ma30d:c.value.ma30d||c.value.ma,ma7d:c.value.ma7d||c.value.ma,wp:c.value.wp,src:'Cached'});
  var cgUrl='https://api.coingecko.com/api/v3/coins/bitcoin/market_chart?vs_currency=usd&days=1400&interval=weekly';
  var bnUrl='https://api.binance.com/api/v3/klines?symbol=BTCUSDT&interval=1w&limit=200';
  return fj(cgUrl,45000).then(parseMAcg).catch(function(){
    return fj(bnUrl,15000).then(parseMAbin);
  }).catch(function(){
    return new Promise(function(ok){setTimeout(ok,5000)}).then(function(){return fj(cgUrl,45000).then(parseMAcg)})
  }).catch(function(){var f=C.any('ma');return f?{ma:f.value.ma,ma2y:f.value.ma2y||f.value.ma,ma90d:f.value.ma90d||f.value.ma,ma30d:f.value.ma30d||f.value.ma,ma7d:f.value.ma7d||f.value.ma,wp:f.value.wp,src:'Cached',stale:true,ct:f.ts}:{ma:0,ma2y:0,ma90d:0,ma30d:0,ma7d:0,wp:[],src:'N/A',err:true}})
}

function fetchFG(){
  var c=C.get('fg',86400000);if(c&&!c.stale)return Promise.resolve({val:c.value.val,txt:c.value.txt,src:'Cached'});
  return fj('https://api.alternative.me/fng/?limit=1').then(function(d){var v={val:parseInt(d.data[0].value,10),txt:d.data[0].value_classification};C.set('fg',v);return{val:v.val,txt:v.txt,src:'Alternative.me'}}).catch(function(){var f=C.any('fg');return f?{val:f.value.val,txt:f.value.txt,src:'Cached',stale:true,ct:f.ts}:{val:50,txt:'Neutral',src:'N/A',err:true}})
}

function fetchFR(){
  var c=C.get('fr',300000);if(c&&!c.stale)return Promise.resolve({rate:c.value,src:'Cached'});
  return fj('https://fapi.binance.com/fapi/v1/fundingRate?symbol=BTCUSDT&limit=1').then(function(d){var r=parseFloat(d[0].fundingRate);C.set('fr',r);return{rate:r,src:'Binance'}}).catch(function(){var f=C.any('fr');return f?{rate:f.value,src:'Cached',stale:true,ct:f.ts}:{rate:0,src:'N/A',err:true}})
}

function fetchHR(){
  var c=C.get('hr',3600000);if(c&&!c.stale)return Promise.resolve({ma30:c.value.ma30,ma60:c.value.ma60,cap:c.value.cap,src:'Cached'});
  return fj('https://mempool.space/api/v1/mining/hashrate/1y',20000).then(function(d){
    if(!d.hashrates||d.hashrates.length<60)throw new Error('insufficient hashrate data');var h=d.hashrates,l6=h.slice(-60),l3=h.slice(-30),s3=0,s6=0;
    for(var i=0;i<l3.length;i++)s3+=l3[i].avgHashrate;for(var i=0;i<l6.length;i++)s6+=l6[i].avgHashrate;
    var m3=s3/l3.length,m6=s6/l6.length,r={ma30:m3,ma60:m6,cap:m3<m6};C.set('hr',r);return{ma30:m3,ma60:m6,cap:r.cap,src:'Mempool.space'}
  }).catch(function(){var f=C.any('hr');return f?{ma30:f.value.ma30,ma60:f.value.ma60,cap:f.value.cap,src:'Cached',stale:true,ct:f.ts}:{ma30:0,ma60:0,cap:false,src:'N/A',err:true}})
}

// ═══════ DAILY PRICE DATA FOR TECHNICAL ANALYSIS ═══════
function fetchDaily(){
  var c=C.get('daily',3600000);if(c&&!c.stale)return Promise.resolve(c.value);
  // Fetch 365 days of daily data from Binance
  return fj('https://api.binance.com/api/v3/klines?symbol=BTCUSDT&interval=1d&limit=365',15000).then(function(data){
    if(!data||data.length<200)throw new Error('insufficient daily data');
    // Extract close prices
    var closes=data.map(function(k){return parseFloat(k[4])});
    // Calculate EMAs
    var ema7=calcEMA(closes,7);
    var ema21=calcEMA(closes,21);
    var sma50=calcSMA(closes,50);
    var sma200=calcSMA(closes,200);
    // Calculate RSI
    var rsi=calcRSI(closes,14);
    // Detect Golden/Death Cross
    var cross=detectCross(closes,50,200);
    // Get recent values
    var current=closes[closes.length-1];
    var result={
      price:current,
      ema7:ema7[ema7.length-1],
      ema21:ema21[ema21.length-1],
      sma50:sma50[sma50.length-1],
      sma200:sma200[sma200.length-1],
      rsi:rsi[rsi.length-1],
      cross:cross,
      // Previous values for trend
      ema7Prev:ema7[ema7.length-2],
      ema21Prev:ema21[ema21.length-2],
      sma50Prev:sma50[sma50.length-2]||sma50[sma50.length-1],
      pricePrev:closes[closes.length-2],
      // Weekly change (7 days ago)
      price7d:closes[closes.length-8]||closes[0],
      // Monthly change (30 days ago)
      price30d:closes[closes.length-31]||closes[0],
      // Quarterly change (90 days ago)
      price90d:closes[closes.length-91]||closes[0],
      src:'Binance'
    };
    C.set('daily',result);
    return result;
  }).catch(function(){
    var f=C.any('daily');
    if(f)return f.value;
    return{price:0,ema7:0,ema21:0,sma50:0,sma200:0,rsi:50,cross:'none',ema7Prev:0,ema21Prev:0,sma50Prev:0,pricePrev:0,price7d:0,price30d:0,price90d:0,src:'N/A',err:true};
  });
}

// Calculate Simple Moving Average
function calcSMA(data,period){
  var result=[];
  for(var i=0;i<data.length;i++){
    if(i<period-1){result.push(null);continue;}
    var sum=0;
    for(var j=0;j<period;j++)sum+=data[i-j];
    result.push(sum/period);
  }
  return result;
}

// Calculate Exponential Moving Average
function calcEMA(data,period){
  var result=[];
  var mult=2/(period+1);
  var ema=data[0];
  for(var i=0;i<data.length;i++){
    if(i===0){result.push(data[0]);continue;}
    ema=(data[i]-ema)*mult+ema;
    result.push(ema);
  }
  return result;
}

// Calculate RSI (Relative Strength Index)
function calcRSI(data,period){
  var result=[];
  var gains=[],losses=[];
  for(var i=1;i<data.length;i++){
    var change=data[i]-data[i-1];
    gains.push(change>0?change:0);
    losses.push(change<0?-change:0);
  }
  for(var i=0;i<gains.length;i++){
    if(i<period-1){result.push(50);continue;}
    var avgGain=0,avgLoss=0;
    for(var j=0;j<period;j++){avgGain+=gains[i-j];avgLoss+=losses[i-j];}
    avgGain/=period;avgLoss/=period;
    if(avgLoss===0){result.push(100);continue;}
    var rs=avgGain/avgLoss;
    result.push(100-(100/(1+rs)));
  }
  return result;
}

// Detect Golden Cross / Death Cross
function detectCross(data,shortPeriod,longPeriod){
  var shortMA=calcSMA(data,shortPeriod);
  var longMA=calcSMA(data,longPeriod);
  var len=data.length;
  if(!shortMA[len-1]||!longMA[len-1]||!shortMA[len-2]||!longMA[len-2])return'none';
  var currAbove=shortMA[len-1]>longMA[len-1];
  var prevAbove=shortMA[len-2]>longMA[len-2];
  // Check last 30 days for recent cross
  for(var i=len-1;i>=len-30&&i>longPeriod;i--){
    var above=shortMA[i]>longMA[i];
    var prevA=shortMA[i-1]>longMA[i-1];
    if(above&&!prevA)return'golden'; // 50 crossed above 200
    if(!above&&prevA)return'death';  // 50 crossed below 200
  }
  return currAbove?'bullish':'bearish';
}

// ═══════ OPTIMIZED CALCULATION FUNCTIONS ═══════
//
// DESIGN PHILOSOPHY: Buy Fear, Sell Euphoria
// - 4 uncorrelated indicators for buy signals
// - 4 uncorrelated indicators for sell signals
// - Single Market Cycle gauge (0=max fear, 100=max euphoria)
// - Historical accuracy weighting
//

// ═══════ PRICE DEVIATION INDEX ═══════
// Consolidates MVRV, Price/200WMA, and Realized Price into ONE metric
// This eliminates multicollinearity - these 3 were ~95% correlated
// Range: 0-100 where 0=extremely undervalued, 100=extremely overvalued
function calcPriceDeviation(p,ma){
  if(!ma||ma<=0)return 50;
  var ratio=p/ma;
  // Historical ranges: 0.5x (bear bottom) to 5x (bull top)
  // Map to 0-100 scale with key inflection points
  if(ratio<=0.5)return 0;
  if(ratio<=0.75)return((ratio-0.5)/0.25)*10; // 0-10
  if(ratio<=1.0)return 10+((ratio-0.75)/0.25)*15; // 10-25
  if(ratio<=1.5)return 25+((ratio-1.0)/0.5)*25; // 25-50
  if(ratio<=2.5)return 50+((ratio-1.5)/1.0)*25; // 50-75
  if(ratio<=4.0)return 75+((ratio-2.5)/1.5)*20; // 75-95
  return Math.min(100,95+((ratio-4.0)/1.0)*5); // 95-100
}

// ═══════ MARKET CYCLE GAUGE ═══════
// Single 0-100 reading: 0=Extreme Fear (buy), 100=Extreme Euphoria (sell)
// Weighted composite of 4 uncorrelated signals
function calcMarketCycle(priceDev,fg,hrCap,fr,rsi){
  // Price Deviation: 35% weight (most reliable historically)
  var pdScore=priceDev;

  // Fear & Greed: 25% weight (sentiment - inversely correlated with price dev)
  var fgScore=fg;

  // Hash Ribbons: 20% weight (miner health - leading indicator)
  // Capitulation = fear (score 0-20), Recovery = neutral (40-60)
  var hrScore=hrCap?15:55;

  // Funding Rate: 10% weight (derivatives positioning)
  // Negative = fear, High positive = greed
  var frPct=fr*100;
  var frScore=frPct<-0.05?10:frPct<0?30:frPct<0.02?50:frPct<0.05?70:90;

  // RSI: 10% weight (momentum confirmation)
  var rsiScore=rsi;

  return Math.round(pdScore*0.35+fgScore*0.25+hrScore*0.20+frScore*0.10+rsiScore*0.10);
}

// ═══════ BUY SCORE (100 max) - 4 UNCORRELATED INDICATORS ═══════
// Each indicator measures something DIFFERENT
function scoreBuy(priceDev,fg,hrCap,fr,maLoaded){
  var indicators=[];
  var totalScore=0;

  // 1. PRICE DEVIATION (35 pts) - Consolidated valuation metric
  // Buy when undervalued (priceDev < 25)
  var pdPts=priceDev<=10?35:priceDev<=20?28:priceDev<=30?20:priceDev<=40?10:0;
  totalScore+=pdPts;
  indicators.push({
    name:'Price Deviation',
    value:priceDev.toFixed(0)+'%',
    pts:pdPts,max:35,
    status:priceDev<=20?'UNDERVALUED':priceDev<=40?'Fair Value':'Overvalued',
    color:priceDev<=20?'#22c55e':priceDev<=40?'#eab308':'#ef4444',
    desc:'Price vs 200W MA (consolidated)',
    buyZone:'<25%',sellZone:'>75%'
  });

  // 2. HASH RIBBONS (30 pts) - Miner capitulation (historically most accurate)
  // 30-day MA < 60-day MA = miners capitulating = strong buy
  var hrPts=hrCap?30:0;
  totalScore+=hrPts;
  indicators.push({
    name:'Hash Ribbons',
    value:hrCap?'CAPITULATION':'Recovery',
    pts:hrPts,max:30,
    status:hrCap?'MINERS STRESSED':'Miners Healthy',
    color:hrCap?'#22c55e':'#64748b',
    desc:'Miner health indicator',
    buyZone:'Capitulation',sellZone:'--'
  });

  // 3. MARKET SENTIMENT (20 pts) - Fear & Greed Index
  // Buy when fear is high (contrarian)
  var fgPts=fg<=15?20:fg<=25?15:fg<=35?10:fg<=45?5:0;
  totalScore+=fgPts;
  indicators.push({
    name:'Market Sentiment',
    value:fg,
    pts:fgPts,max:20,
    status:fg<=20?'EXTREME FEAR':fg<=40?'Fear':fg<=60?'Neutral':fg<=80?'Greed':'EXTREME GREED',
    color:fg<=25?'#22c55e':fg<=40?'#86efac':fg<=60?'#eab308':fg<=80?'#fb923c':'#ef4444',
    desc:'Fear & Greed Index',
    buyZone:'<25',sellZone:'>75'
  });

  // 4. DERIVATIVES SENTIMENT (15 pts) - Funding Rate
  // Negative funding = shorts paying longs = bearish crowd = buy signal
  var frPct=fr*100;
  var frPts=frPct<-0.03?15:frPct<-0.01?12:frPct<0?8:frPct<0.01?4:0;
  totalScore+=frPts;
  indicators.push({
    name:'Funding Rate',
    value:(frPct>=0?'+':'')+frPct.toFixed(3)+'%',
    pts:frPts,max:15,
    status:frPct<-0.01?'SHORTS DOMINANT':frPct<0.01?'Neutral':'Longs Dominant',
    color:frPct<-0.01?'#22c55e':frPct<0.02?'#eab308':'#ef4444',
    desc:'Perpetual futures sentiment',
    buyZone:'<0%',sellZone:'>0.05%'
  });

  return{score:totalScore,max:100,indicators:indicators};
}

// ═══════ SELL SCORE (100 max) - 4 UNCORRELATED INDICATORS ═══════
function scoreSell(priceDev,fg,fr,rsi,maLoaded){
  var indicators=[];
  var totalScore=0;

  // 1. PRICE DEVIATION (35 pts) - Sell when overvalued
  var pdPts=priceDev>=90?35:priceDev>=80?28:priceDev>=70?20:priceDev>=60?10:0;
  totalScore+=pdPts;
  indicators.push({
    name:'Price Deviation',
    value:priceDev.toFixed(0)+'%',
    pts:pdPts,max:35,
    status:priceDev>=80?'OVERVALUED':priceDev>=60?'Elevated':'Fair Value',
    color:priceDev>=80?'#ef4444':priceDev>=60?'#fb923c':'#64748b',
    desc:'Price vs 200W MA',
    threshold:'>75% = Sell Zone'
  });

  // 2. MARKET MANIA (30 pts) - Extreme Greed
  var fgPts=fg>=90?30:fg>=80?24:fg>=70?16:fg>=60?8:0;
  totalScore+=fgPts;
  indicators.push({
    name:'Market Mania',
    value:fg,
    pts:fgPts,max:30,
    status:fg>=80?'EUPHORIA':fg>=60?'Greed':'Neutral',
    color:fg>=80?'#ef4444':fg>=60?'#fb923c':'#64748b',
    desc:'Fear & Greed sustained high',
    threshold:'>80 = Euphoria'
  });

  // 3. MOMENTUM EXHAUSTION (20 pts) - RSI Overbought
  var rsiPts=rsi>=85?20:rsi>=75?15:rsi>=70?10:rsi>=65?5:0;
  totalScore+=rsiPts;
  indicators.push({
    name:'Momentum',
    value:rsi.toFixed(0),
    pts:rsiPts,max:20,
    status:rsi>=75?'OVERBOUGHT':rsi>=60?'Strong':rsi>=40?'Neutral':'Weak',
    color:rsi>=75?'#ef4444':rsi>=60?'#fb923c':'#64748b',
    desc:'RSI (14) daily',
    threshold:'>75 = Exhaustion'
  });

  // 4. LEVERAGE EXCESS (15 pts) - High positive funding
  var frPct=fr*100;
  var frPts=frPct>=0.08?15:frPct>=0.05?12:frPct>=0.03?8:frPct>=0.02?4:0;
  totalScore+=frPts;
  indicators.push({
    name:'Leverage',
    value:(frPct>=0?'+':'')+frPct.toFixed(3)+'%',
    pts:frPts,max:15,
    status:frPct>=0.05?'EXCESSIVE':frPct>=0.02?'Elevated':'Normal',
    color:frPct>=0.05?'#ef4444':frPct>=0.02?'#fb923c':'#64748b',
    desc:'Funding rate premium',
    threshold:'>0.05% = Crowded'
  });

  return{score:totalScore,max:100,indicators:indicators};
}

// ═══════ ACTION SIGNALS ═══════
function getAction(cycle,buyScore,sellScore){
  // Primary driver is cycle position, confirmed by scores
  if(cycle<=15){
    return{
      action:'HEAVY BUY',
      allocation:100,
      color:'#22c55e',
      desc:'Maximum fear - deploy all available capital',
      confidence:buyScore>=70?'HIGH':buyScore>=50?'MEDIUM':'LOW'
    };
  }
  if(cycle<=30){
    return{
      action:'BUY',
      allocation:75,
      color:'#22c55e',
      desc:'Fear zone - strong accumulation',
      confidence:buyScore>=50?'HIGH':buyScore>=30?'MEDIUM':'LOW'
    };
  }
  if(cycle<=45){
    return{
      action:'ACCUMULATE',
      allocation:50,
      color:'#86efac',
      desc:'Approaching fair value - DCA in',
      confidence:'MEDIUM'
    };
  }
  if(cycle<=55){
    return{
      action:'HOLD',
      allocation:0,
      color:'#eab308',
      desc:'Neutral zone - hold positions',
      confidence:'--'
    };
  }
  if(cycle<=70){
    return{
      action:'REDUCE',
      allocation:25,
      color:'#fb923c',
      desc:'Getting greedy - take some profits',
      confidence:sellScore>=30?'MEDIUM':'LOW'
    };
  }
  if(cycle<=85){
    return{
      action:'SELL',
      allocation:50,
      color:'#f97316',
      desc:'Greed zone - significant profit taking',
      confidence:sellScore>=50?'HIGH':'MEDIUM'
    };
  }
  return{
    action:'HEAVY SELL',
    allocation:100,
    color:'#ef4444',
    desc:'Maximum euphoria - exit most positions',
    confidence:sellScore>=70?'HIGH':sellScore>=50?'MEDIUM':'LOW'
  };
}

function fp(p){return(!p||p===0)?'$--':'$'+p.toLocaleString('en-US',{minimumFractionDigits:0,maximumFractionDigits:0})}
function ft(t){return!t?'--':new Date(t).toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit',second:'2-digit'})}

// ═══════ SVG CHART ═══════
function buildChart(data){
  if(!data||data.length<2)return'<div style="text-align:center;color:#64748b;padding:20px">Chart data loading...</div>';
  var W=600,H=250,pl=55,pr=15,pt=15,pb=35;var cW=W-pl-pr,cH=H-pt-pb;
  var prices=data.map(function(d){return d.p}),mas=data.map(function(d){return d.m});
  var all=prices.concat(mas),mn=Math.min.apply(null,all)*0.95,mx=Math.max.apply(null,all)*1.05,rng=mx-mn||1;
  function x(i){return pl+(i/(data.length-1))*cW}
  function y(v){return pt+cH-((v-mn)/rng)*cH}
  var pp='M'+data.map(function(d,i){return x(i)+','+y(d.p)}).join('L');
  var mp='M'+data.map(function(d,i){return x(i)+','+y(d.m)}).join('L');
  var ap=pp+'L'+x(data.length-1)+','+(pt+cH)+'L'+pl+','+(pt+cH)+'Z';
  var svg='<svg viewBox="0 0 '+W+' '+H+'" style="width:100%;height:auto">';
  svg+='<defs><linearGradient id="af" x1="0" y1="0" x2="0" y2="1"><stop offset="0%" stop-color="#3b82f6" stop-opacity="0.3"/><stop offset="100%" stop-color="#3b82f6" stop-opacity="0.02"/></linearGradient></defs>';
  for(var i=0;i<=4;i++){var yy=pt+(cH*i/4);svg+='<line x1="'+pl+'" y1="'+yy+'" x2="'+(W-pr)+'" y2="'+yy+'" stroke="#1e293b" stroke-width="1"/>';var val=mn+(rng*(4-i)/4);svg+='<text x="'+(pl-4)+'" y="'+(yy+3)+'" text-anchor="end" fill="#4a5568" font-size="9" font-family="monospace">$'+(val/1000).toFixed(0)+'k</text>'}
  var step=Math.max(1,Math.floor(data.length/6));for(var i=0;i<data.length;i+=step){svg+='<text x="'+x(i)+'" y="'+(H-5)+'" text-anchor="middle" fill="#4a5568" font-size="8" font-family="monospace">'+data[i].d+'</text>'}
  svg+='<path d="'+ap+'" fill="url(#af)"/>';
  svg+='<path d="'+pp+'" fill="none" stroke="#3b82f6" stroke-width="2"/>';
  svg+='<path d="'+mp+'" fill="none" stroke="#f59e0b" stroke-width="2" stroke-dasharray="6 3"/>';
  svg+='</svg>';return svg;
}

// ═══════ GAUGES ═══════
function buildGauge(sc,max,color){
  var pct=Math.min((sc/max)*100,100);
  return'<svg width="120" height="70" viewBox="0 0 120 70"><path d="M 10 65 A 50 50 0 0 1 110 65" fill="none" stroke="#1e293b" stroke-width="8" stroke-linecap="round"/><path d="M 10 65 A 50 50 0 0 1 110 65" fill="none" stroke="'+color+'" stroke-width="8" stroke-linecap="round" stroke-dasharray="'+(pct/100*157)+' 157"/><text x="60" y="55" text-anchor="middle" fill="'+color+'" font-size="18" font-weight="bold" font-family="monospace">'+sc+'</text><text x="60" y="68" text-anchor="middle" fill="#94a3b8" font-size="8" font-family="monospace">/ '+max+'</text></svg>';
}

// ═══════ RENDER ═══════
var state={price:{price:0,src:''},ma:{ma:0,ma2y:0,ma90d:0,ma30d:0,ma7d:0,wp:[]},fg:{val:50,txt:'Neutral'},fr:{rate:0},hr:{cap:false},daily:{price:0,ema7:0,ema21:0,sma50:0,sma200:0,rsi:50,cross:'none',price7d:0,price30d:0,price90d:0},lastUp:null,countdown:60};

function render(){
  var p=state.price,ma=state.ma,fg=state.fg,fr=state.fr,hr=state.hr,daily=state.daily;
  var maLoaded=ma.ma>0;
  var dailyLoaded=daily.ema7>0;

  // ═══════ CORE CALCULATIONS ═══════
  var priceDev=calcPriceDeviation(p.price,ma.ma);
  var rsi=daily.rsi||50;
  var cycle=calcMarketCycle(priceDev,fg.val,hr.cap,fr.rate,rsi);

  // Get scores from optimized 4-indicator system
  var buyRes=scoreBuy(priceDev,fg.val,hr.cap,fr.rate,maLoaded);
  var sellRes=scoreSell(priceDev,fg.val,fr.rate,rsi,maLoaded);
  var action=getAction(cycle,buyRes.score,sellRes.score);

  // Price changes
  var chg7d=daily.price7d>0?((p.price-daily.price7d)/daily.price7d)*100:0;
  var chg30d=daily.price30d>0?((p.price-daily.price30d)/daily.price30d)*100:0;
  var chg90d=daily.price90d>0?((p.price-daily.price90d)/daily.price90d)*100:0;

  // EMA/MA structure
  var emaAlign=dailyLoaded?(p.price>daily.ema7&&daily.ema7>daily.ema21?'bullish':p.price<daily.ema7&&daily.ema7<daily.ema21?'bearish':'neutral'):'loading';
  var maStructure=dailyLoaded?(daily.sma50>daily.sma200?'bullish':'bearish'):'loading';
  var crossStatus=daily.cross||'none';

  // Cycle zone labels
  var cycleZone=cycle<=15?{label:'EXTREME FEAR',color:'#22c55e',bg:'rgba(34,197,94,0.15)'}:
                cycle<=30?{label:'FEAR',color:'#86efac',bg:'rgba(134,239,172,0.1)'}:
                cycle<=45?{label:'CAUTION',color:'#fde047',bg:'rgba(253,224,71,0.1)'}:
                cycle<=55?{label:'NEUTRAL',color:'#eab308',bg:'rgba(234,179,8,0.1)'}:
                cycle<=70?{label:'GREED',color:'#fb923c',bg:'rgba(251,146,60,0.1)'}:
                cycle<=85?{label:'HIGH GREED',color:'#f97316',bg:'rgba(249,115,22,0.1)'}:
                          {label:'EXTREME EUPHORIA',color:'#ef4444',bg:'rgba(239,68,68,0.15)'};

  var html='<div class="container">';

  // ═══════ HEADER ═══════
  html+='<div class="header"><h1>Bitcoin Fear & Greed Trading Dashboard</h1>';
  html+='<p class="sub">Buy Fear \u2022 Sell Euphoria \u2022 4 Uncorrelated Indicators</p>';
  html+='<div class="meta"><span>'+fp(p.price)+'</span><span>\u2022</span><span>'+ft(state.lastUp)+'</span><span>\u2022</span><span>Next: '+state.countdown+'s</span></div></div>';

  // ═══════ MARKET CYCLE GAUGE ═══════
  html+='<div class="cycle-panel" style="border-color:'+cycleZone.color+'">';
  html+='<div class="cycle-title">Market Cycle Position</div>';
  html+='<div class="cycle-gauge"><div class="cycle-bar"><div class="cycle-needle" style="left:'+cycle+'%"></div></div>';
  html+='<div class="cycle-zones"><span>0 FEAR</span><span>25</span><span>50</span><span>75</span><span>100 GREED</span></div></div>';
  html+='<div class="cycle-value" style="color:'+cycleZone.color+'">'+cycle+'</div>';
  html+='<div class="cycle-label" style="color:'+cycleZone.color+'">'+cycleZone.label+'</div>';
  html+='<div class="cycle-action" style="background:'+cycleZone.bg+';border:2px solid '+action.color+';color:'+action.color+'"><strong>'+action.action+'</strong> \u2022 Deploy '+action.allocation+'% \u2022 Confidence: '+action.confidence+'</div>';
  html+='</div>';

  // ═══════ ACTION PANEL ═══════
  html+='<div class="action-panel">';
  // Price Box
  html+='<div class="action-box"><div class="label">BTC Price</div><div class="value" style="color:#fff">'+fp(p.price)+'</div><div class="sub">vs 200W MA: '+(maLoaded?(priceDev).toFixed(0)+'%':'--')+'</div></div>';
  // Action Box
  var actionClass=action.allocation>0?(cycle<=50?'active':'active-sell'):'';
  html+='<div class="action-box '+actionClass+'"><div class="label">Recommended Action</div><div class="value" style="color:'+action.color+'">'+action.action+'</div><div class="sub">'+action.desc+'</div></div>';
  // Allocation Box
  html+='<div class="action-box"><div class="label">'+(cycle<=50?'Buy':'Sell')+' Allocation</div><div class="value" style="color:'+action.color+'">'+action.allocation+'%</div><div class="sub">'+(cycle<=50?'of available capital':'of holdings')+'</div></div>';
  html+='</div>';

  // ═══════ CONFIDENCE / INDICATOR AGREEMENT ═══════
  var buyActive=buyRes.indicators.filter(function(i){return i.pts>0}).length;
  var sellActive=sellRes.indicators.filter(function(i){return i.pts>0}).length;
  var agreePct=cycle<=50?Math.round((buyActive/4)*100):Math.round((sellActive/4)*100);
  var agreeColor=agreePct>=75?'#22c55e':agreePct>=50?'#eab308':'#64748b';

  html+='<div class="confidence-section">';
  html+='<div class="confidence-header"><span class="confidence-title">Indicator Agreement</span><span class="confidence-value" style="color:'+agreeColor+'">'+(cycle<=50?buyActive:sellActive)+'/4 indicators confirm ('+(cycle<=50?'buy':'sell')+')</span></div>';
  html+='<div class="confidence-bar">';
  html+='<div class="confidence-segment" style="width:'+(buyRes.score)+'%;background:#22c55e"></div>';
  html+='<div class="confidence-segment" style="width:'+(100-buyRes.score-sellRes.score)+'%;background:#334155"></div>';
  html+='<div class="confidence-segment" style="width:'+(sellRes.score)+'%;background:#ef4444"></div>';
  html+='</div>';
  html+='<div class="indicator-dots">';
  for(var i=0;i<buyRes.indicators.length;i++){
    var ind=buyRes.indicators[i];
    var dotClass=ind.pts>0?'active-buy':'neutral';
    html+='<div class="indicator-dot"><div class="dot '+dotClass+'"></div><div class="name">'+ind.name+'</div></div>';
  }
  html+='</div></div>';

  // ═══════ BUY INDICATORS (4 cards) ═══════
  html+='<div class="indicators-grid">';
  for(var i=0;i<buyRes.indicators.length;i++){
    var ind=buyRes.indicators[i];
    var fillPct=(ind.pts/ind.max)*100;
    html+='<div class="ind-card">';
    html+='<div class="ind-name">'+ind.name+'<span class="ind-weight">'+ind.max+' pts</span></div>';
    html+='<div class="ind-value" style="color:'+ind.color+'">'+ind.value+'</div>';
    html+='<div class="ind-status" style="color:'+ind.color+'">'+ind.status+' ('+ind.pts+'/'+ind.max+')</div>';
    html+='<div class="ind-meter"><div class="ind-fill" style="width:'+fillPct+'%;background:'+ind.color+'"></div></div>';
    html+='<div class="ind-thresholds"><span>Buy: '+ind.buyZone+'</span><span>Sell: '+ind.sellZone+'</span></div>';
    html+='</div>';
  }
  html+='</div>';

  // ═══════ PRICE ACTION PANEL ═══════
  html+='<div class="price-action">';

  // Short-term
  var shortColor=emaAlign==='bullish'?'#22c55e':emaAlign==='bearish'?'#ef4444':'#eab308';
  var shortDir=emaAlign==='bullish'?'↑':emaAlign==='bearish'?'↓':'→';
  var shortLabel=emaAlign==='bullish'?'BULLISH':emaAlign==='bearish'?'BEARISH':'NEUTRAL';
  html+='<div class="pa-card">';
  html+='<div class="pa-period">Short-Term (Daily)</div>';
  html+='<div class="pa-main"><span class="pa-signal" style="color:'+shortColor+'">'+shortDir+'</span><span class="pa-label" style="color:'+shortColor+'">'+shortLabel+'</span></div>';
  html+='<div class="pa-details">';
  html+='<div class="pa-row"><span>RSI (14)</span><span style="color:'+(rsi<30?'#22c55e':rsi>70?'#ef4444':'#eab308')+'">'+rsi.toFixed(0)+'</span></div>';
  html+='<div class="pa-row"><span>7D Change</span><span style="color:'+(chg7d>=0?'#22c55e':'#ef4444')+'">'+(chg7d>=0?'+':'')+chg7d.toFixed(1)+'%</span></div>';
  html+='<div class="pa-row"><span>7/21 EMA</span><span>'+fp(daily.ema7)+' / '+fp(daily.ema21)+'</span></div>';
  html+='</div></div>';

  // Medium-term
  var medColor=maStructure==='bullish'?'#22c55e':'#ef4444';
  var medDir=maStructure==='bullish'?'↑':'↓';
  var medLabel=maStructure==='bullish'?'BULLISH':'BEARISH';
  var crossLabel=crossStatus==='golden'?'GOLDEN':crossStatus==='death'?'DEATH':crossStatus==='bullish'?'50>200':'50<200';
  html+='<div class="pa-card">';
  html+='<div class="pa-period">Medium-Term (Weekly)</div>';
  html+='<div class="pa-main"><span class="pa-signal" style="color:'+medColor+'">'+medDir+'</span><span class="pa-label" style="color:'+medColor+'">'+medLabel+'</span></div>';
  html+='<div class="pa-details">';
  html+='<div class="pa-row"><span>MA Cross</span><span style="color:'+medColor+'">'+crossLabel+'</span></div>';
  html+='<div class="pa-row"><span>30D Change</span><span style="color:'+(chg30d>=0?'#22c55e':'#ef4444')+'">'+(chg30d>=0?'+':'')+chg30d.toFixed(1)+'%</span></div>';
  html+='<div class="pa-row"><span>50/200 SMA</span><span>'+fp(daily.sma50)+' / '+fp(daily.sma200)+'</span></div>';
  html+='</div></div>';

  // Long-term
  var longPct=ma.ma>0?((p.price-ma.ma)/ma.ma)*100:0;
  var longColor=longPct>0?'#22c55e':'#ef4444';
  var longDir=longPct>10?'↑':longPct<-10?'↓':'→';
  var longLabel=longPct>50?'STRONG BULL':longPct>0?'BULL':longPct>-30?'BEAR':'DEEP BEAR';
  html+='<div class="pa-card">';
  html+='<div class="pa-period">Long-Term (Monthly)</div>';
  html+='<div class="pa-main"><span class="pa-signal" style="color:'+longColor+'">'+longDir+'</span><span class="pa-label" style="color:'+longColor+'">'+longLabel+'</span></div>';
  html+='<div class="pa-details">';
  html+='<div class="pa-row"><span>200W MA</span><span>'+fp(ma.ma)+'</span></div>';
  html+='<div class="pa-row"><span>90D Change</span><span style="color:'+(chg90d>=0?'#22c55e':'#ef4444')+'">'+(chg90d>=0?'+':'')+chg90d.toFixed(1)+'%</span></div>';
  html+='<div class="pa-row"><span>Cycle</span><span>'+priceDev.toFixed(0)+'% (0=bottom, 100=top)</span></div>';
  html+='</div></div>';

  html+='</div>';

  // ═══════ HISTORICAL CONTEXT ═══════
  html+='<div class="history-panel">';
  html+='<div class="history-title">Historical Accuracy at Current Level</div>';
  html+='<div class="history-grid">';

  // Match current reading to historical
  var histMatch=cycle<=20?{period:'Nov 2022, Mar 2020',signal:'HEAVY BUY',result:'+300-1600%',acc:'95%'}:
                cycle<=35?{period:'Jun 2022, Sep 2019',signal:'BUY',result:'+50-200%',acc:'85%'}:
                cycle<=55?{period:'Mid-cycle ranges',signal:'HOLD',result:'Variable',acc:'--'}:
                cycle<=75?{period:'Feb 2021, Oct 2020',signal:'REDUCE',result:'Avoided -30%',acc:'70%'}:
                          {period:'Nov 2021, Dec 2017',signal:'HEAVY SELL',result:'Avoided -77-84%',acc:'90%'};

  html+='<div class="history-item"><div class="h-label">Similar Readings</div><div class="h-value">'+histMatch.period+'</div><div class="h-note">When cycle was '+cycle+'</div></div>';
  html+='<div class="history-item"><div class="h-label">Signal Given</div><div class="h-value" style="color:'+action.color+'">'+histMatch.signal+'</div><div class="h-note">Accuracy: '+histMatch.acc+'</div></div>';
  html+='<div class="history-item"><div class="h-label">Subsequent Result</div><div class="h-value" style="color:'+(cycle<=50?'#22c55e':'#ef4444')+'">'+histMatch.result+'</div><div class="h-note">Following 12 months</div></div>';
  html+='<div class="history-item"><div class="h-label">Current Indicators</div><div class="h-value">'+(cycle<=50?buyActive:sellActive)+'/4 Confirm</div><div class="h-note">'+(agreePct>=75?'HIGH agreement':'PARTIAL agreement')+'</div></div>';
  html+='</div></div>';

  // ═══════ STRATEGY ═══════
  if(action.allocation>0){
    html+='<div class="strategy-panel">';
    html+='<div class="strategy-title">'+(cycle<=50?'Buy':'Sell')+' Ladder Strategy</div>';
    html+='<div class="strategy-action"><div class="sa-label">Recommended Deployment</div><div class="sa-value" style="color:'+action.color+'">'+action.allocation+'%</div><div class="sa-note">'+(cycle<=50?'of available capital to deploy':'of holdings to exit')+'</div></div>';

    if(cycle<=50){
      // Buy ladder
      html+='<div class="ladder-grid">';
      html+='<div class="ladder-item"><div class="l-label">Tranche 1 (40%)</div><div class="l-price">@ '+fp(p.price)+'</div><div class="l-alloc" style="color:#22c55e">Now</div></div>';
      html+='<div class="ladder-item"><div class="l-label">Tranche 2 (30%)</div><div class="l-price">@ '+fp(p.price*0.95)+'</div><div class="l-alloc" style="color:#86efac">-5%</div></div>';
      html+='<div class="ladder-item"><div class="l-label">Tranche 3 (30%)</div><div class="l-price">@ '+fp(p.price*0.90)+'</div><div class="l-alloc" style="color:#86efac">-10%</div></div>';
      html+='</div>';
    } else {
      // Sell ladder
      html+='<div class="ladder-grid">';
      html+='<div class="ladder-item"><div class="l-label">Tranche 1 (40%)</div><div class="l-price">@ '+fp(p.price)+'</div><div class="l-alloc" style="color:#ef4444">Now</div></div>';
      html+='<div class="ladder-item"><div class="l-label">Tranche 2 (30%)</div><div class="l-price">@ '+fp(p.price*1.10)+'</div><div class="l-alloc" style="color:#fb923c">+10%</div></div>';
      html+='<div class="ladder-item"><div class="l-label">Tranche 3 (30%)</div><div class="l-price">@ '+fp(p.price*1.20)+'</div><div class="l-alloc" style="color:#fb923c">+20%</div></div>';
      html+='</div>';
    }
    html+='</div>';
  }

  // ═══════ CHART ═══════
  html+='<div class="chart-card">';
  html+='<div class="chart-title">52-Week Price vs 200-Week MA</div>';
  html+=buildChart(ma.wp);
  html+='<div class="chart-legend"><span><span class="dot" style="background:#3b82f6"></span>BTC Price</span><span><span class="dot" style="background:#f59e0b"></span>200W MA</span></div>';
  html+='</div>';

  // ═══════ FOOTER ═══════
  html+='<div class="footer">';
  html+='<div class="footer-grid"><div>\u2022 Price: Binance</div><div>\u2022 200W MA: CoinGecko</div><div>\u2022 F&G: Alternative.me</div><div>\u2022 Funding: Binance Futures</div><div>\u2022 Hash Rate: Mempool.space</div><div>\u2022 Daily Data: Binance</div></div>';
  html+='<div class="warn-box warn-yellow"><strong>OPTIMIZED DESIGN:</strong> 4 uncorrelated indicators replace 7 redundant ones. Price Deviation consolidates MVRV, Price/200WMA, and Realized Price (which were 95% correlated). Hash Ribbons weighted higher (historically most accurate bottom signal).</div>';
  html+='<div class="warn-box warn-red"><strong>DISCLAIMER:</strong> Educational purposes only. Not financial advice. Past performance does not guarantee future results. Always manage risk appropriately.</div>';
  html+='</div>';

  html+='</div>';

  document.getElementById('app').className='';
  document.getElementById('app').innerHTML=html;
}

// ═══════ INIT ═══════
function fetchAll(){
  return Promise.all([fetchPrice(),fetchMA(),fetchFG(),fetchFR(),fetchHR(),fetchDaily()].map(function(p){return p.catch(function(e){return null})})).then(function(r){
    if(r[0])state.price=r[0];if(r[1])state.ma=r[1];if(r[2])state.fg=r[2];if(r[3])state.fr=r[3];if(r[4])state.hr=r[4];if(r[5])state.daily=r[5];
    state.lastUp=Date.now();state.countdown=60;render();
  });
}
fetchAll().then(function(){
  if(!state.ma||state.ma.ma<=0){
    var maRetry=setInterval(function(){
      fetchMA().then(function(r){if(r&&r.ma>0){state.ma=r;render();clearInterval(maRetry)}});
    },10000);
    setTimeout(function(){clearInterval(maRetry)},120000);
  }
});
setInterval(function(){fetchPrice().then(function(p){if(p)state.price=p;render()})},30000);
setInterval(fetchAll,60000);
setInterval(function(){state.countdown=Math.max(0,state.countdown-1);var el=document.querySelector('.meta');if(el){var spans=el.querySelectorAll('span');if(spans.length>=3)spans[2].textContent='Next refresh: '+state.countdown+'s'}},1000);
})();
</script>
</body>
</html>
